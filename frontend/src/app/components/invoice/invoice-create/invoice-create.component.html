<div class="invoice-container">
  <h2>{{ editId ? 'Edit Invoice' : 'Create Invoice' }}</h2>

  <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">

    <!-- INVOICE INFO -->
    <div class="invoice-info" formGroupName="invoice">

      <!-- BILL FROM -->
      <div class="input-container">
        <label>Bill from <sup>*</sup></label>
        <select formControlName="bill_from_id"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.bill_from_id')?.invalid && submited}">
          <option value="">Select bill from</option>
          <option *ngFor="let item of customerDataFrom" [value]="item.customer_id">
            {{ item.name }}
          </option>
        </select>
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.bill_from_id')?.invalid">
          This field is required
        </p>
      </div>

      <!-- BILL TO -->
      <div class="input-container">
        <label>Bill to <sup>*</sup></label>
        <select formControlName="bill_to_id"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.bill_to_id')?.invalid && submited}">
          <option value="">Select bill to</option>
          <option *ngFor="let item of customerDataTo" [value]="item.customer_id">
            {{ item.name }}
          </option>
        </select>
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.bill_to_id')?.invalid">
          This field is required
        </p>
      </div>

      <!-- INVOICE DATE -->
      <div class="input-container">
        <label>Invoice date <sup>*</sup></label>
        <input type="date" formControlName="invoice_date"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.invoice_date')?.invalid && submited}">
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.invoice_date')?.invalid">
          This field is required
        </p>
      </div>

      <!-- DUE DATE -->
      <div class="input-container">
        <label>Due date <sup>*</sup></label>
        <input type="date" formControlName="due_date"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.due_date')?.invalid && submited}">
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.due_date')?.invalid">
          This field is required
        </p>
      </div>

      <!-- PAYMENT STATUS -->
      <div class="input-container">
        <label>Payment status <sup>*</sup></label>
        <select formControlName="payment_status"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.payment_status')?.invalid && submited}">
          <option value="">Select status</option>
          <option *ngFor="let item of paymentStatus" [value]="item.value">
            {{ item.value }}
          </option>
        </select>
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.payment_status')?.invalid">
          This field is required
        </p>
      </div>

      <!-- TAX RATE -->
      <div class="input-container">
        <label>Tax rate (%)</label>
        <input type="text" formControlName="tax_rate" appDecimalOnly placeholder="Enter tax"
          (input)="calculateTotals()">
      </div>

    </div>

    <!-- ITEMS SECTION -->
    <h3>Items</h3>
    <table class="invoice-table">
      <thead>
        <tr>
          <th>Description</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody formArrayName="items">
        <tr *ngFor="let item of getitemsForms().controls; let i = index" [formGroupName]="i">

          <td>
            <input type="text" formControlName="description" placeholder="Description"
              [class.invalid-border]="submited && item.get('description')?.invalid">
          </td>

          <td>
            <input type="text" formControlName="price" appDecimalOnly placeholder="Price" (input)="calculateTotals()"
              [class.invalid-border]="submited && item.get('price')?.invalid">
          </td>

          <td>
            <input type="text" formControlName="quantity" appOnlyNumbers placeholder="Qty" (input)="calculateTotals()"
              [class.invalid-border]="submited && item.get('quantity')?.invalid">
          </td>

          <td>{{ item.get('total')?.value | currency:'INR' }}</td>

          <td>
            <button type="button" (click)="removeItem(i)" [disabled]="getitemsForms().length === 1">
              Remove
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <button type="button" class="add-btn" (click)="addItem()">+ Add Item</button>

    <!-- PAYMENT & TERMS (NO formGroupName HERE) -->
    <div class="invoice-info" style="margin-top:15px" formGroupName="invoice">

      <div class="input-container">
        <label>Payment Method <sup>*</sup></label>
        <select formControlName="payment_id"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.payment_id')?.invalid && submited}">
          <option value="">Select payment method</option>
          <option *ngFor="let method of paymentMethods" [value]="method.payment_id">
            {{ method.bank_name }} ({{ method.account_number }})
          </option>
        </select>
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.payment_id')?.invalid">
          This field is required
        </p>
      </div>

      <div class="input-container">
        <label>Terms & Conditions <sup>*</sup></label>
        <select formControlName="term_id"
          [ngClass]="{'invalid-input': invoiceForm.get('invoice.term_id')?.invalid && submited}">
          <option value="">Select terms</option>
          <option *ngFor="let term of termsOptions" [value]="term.term_id">
            {{ term.terms }}
          </option>
        </select>
        <p class="error-msg" *ngIf="submited && invoiceForm.get('invoice.term_id')?.invalid">
          This field is required
        </p>
      </div>

    </div>

    <!-- TOTALS -->
    <div class="totals">
      <p>Subtotal: {{ invoiceForm.get('invoice.subtotal')?.value | currency:'INR' }}</p>
      <p>Total: {{ invoiceForm.get('invoice.total')?.value | currency:'INR' }}</p>
    </div>

    <button type="submit" class="save-btn"><i class="fas fa-save"></i> Save Invoice</button>
    <button class="btn-delete" [routerLink]="['/invoices']"><i class="fas fa-times"></i> Cancel</button>

  </form>
</div>